
# 지능형 레시피 안내 및 마트 재료 매칭 시스템

## 1. 프로젝트 개요

본 프로젝트는 사용자의 자연어 질문(예: "김치찌개 레시피와 재료 위치 알려줘")에 대해, 대규모 언어 모델(LLM)을 활용하여 요청된 요리의 레시피를 생성하고, 해당 레시피에 필요한 재료 목록을 추출합니다. 더 나아가, 추출된 재료와 시스템에 등록된 마트 재료 목록(위치 정보 및 동의어 포함)을 비교 분석하여, 사용자가 마트에서 어떤 재료를 구매할 수 있는지, 유사한 대체품은 무엇인지, 혹은 어떤 재료가 없는지를 명확하게 안내하는 지능형 시스템입니다.

사용자의 요리 준비 과정을 실질적으로 돕는 것을 목표로 하며, 단순 정보 검색을 넘어선 개인 맞춤형 쇼핑 도우미 및 레시피 안내 경험을 제공하고자 합니다.

## 2. 주요 기능

*   **자연어 질의응답:** 사용자의 다양한 요리 관련 질문 이해 및 처리.
*   **LLM 기반 레시피 생성:** 요청된 요리에 대한 상세한 조리법 생성.
*   **LLM 기반 재료 추출:** 생성된 레시피에서 필요한 재료 목록 자동 추출.
*   **고급 RAG 기반 재료 매칭:**
    *   마트 재료 목록과 레시피 재료 간의 **정확한 일치** 항목 탐색.
    *   **의미론적 & 어휘적 유사도**를 종합적으로 고려한 유사 재료 추천:
        *   **다중 Bi-Encoder 모델:** 2개의 한국어 특화 Bi-Encoder 모델(`jhgan/ko-sroberta-multitask`, `snunlp/KR-SBERT-V40K-klueNLI-augSTS`) 결과 평균 사용.
        *   **다중 Cross-Encoder 모델:** 2개의 Cross-Encoder 모델(`bongsoo/kpf-cross-encoder-v1`, `cross-encoder/ms-marco-MiniLM-L-6-v2`) 결과 평균 사용.
        *   **어휘적 유사도:** Jaccard 유사도와 Levenshtein 거리 평균 사용.
        *   **가중합 점수:** 위 세 가지 유사도 점수를 0.4 (Bi-Encoder 평균), 0.4 (Cross-Encoder 평균), 0.2 (어휘적 유사도) 비율로 가중합하여 최종 유사도 산출.
        *   **정교한 점수 정규화:** 각 Encoder 점수를 전체 후보 재료 집단에 대해 Min-Max 정규화 (Bi-avg: 0~1, Cross1: 0~1, Cross2: -1~1) 후 결합.
    *   **동의어 처리:** 마트 재료명에 동의어/유사어 배열을 지원하여 매칭률 향상.
*   **재료 상태 분류:** 각 레시피 재료에 대해 "구매 가능 (정확히 일치)", "유사/대체 가능", "마트에 없음"으로 상태 분류.
*   **재료 위치 안내:** 구매 가능한 재료 및 유사 재료의 마트 내 위치 코드 제공.
*   **종합 답변 생성:** LLM이 레시피, 재료 목록, 재료 상태 및 위치 정보를 종합하여 사용자에게 친절하고 명확한 최종 답변 제공.

## 3. 기술 스택

*   **프로그래밍 언어:** Python 3.x
*   **주요 라이브러리:**
    *   `transformers`: 대규모 언어 모델(LLM) 로딩 및 추론 (Hugging Face)
    *   `sentence-transformers`: Bi-Encoder 및 Cross-Encoder 모델 활용
    *   `faiss-cpu`: 유사 벡터 검색 (RAG의 핵심 요소)
    *   `torch`: 딥러닝 프레임워크 (PyTorch)
    *   `numpy`: 수치 연산
    *   `thefuzz` (또는 `fuzzywuzzy`): 어휘적 유사도 계산 (Jaccard, Levenshtein)
*   **데이터 저장:** JSON 파일 (`materials.json`, `recipes.json`, `ingredients.json`)
*   **LLM 모델 예시:** `naver-hyperclovax/HyperCLOVAX-SEED-Vision-Instruct-3B` (또는 사용자가 선택한 다른 모델)

## 4. 시스템 아키텍처 및 작동 흐름

본 시스템은 "단계별 전문가 시스템"과 유사한 파이프라인으로 작동합니다.

1.  **사용자 입력 (Query):** 사용자가 `api.py`를 통해 요리 관련 질문을 입력합니다. (예: "돼지고기 김치찌개 레시피와 재료 위치 좀 알려줘")
2.  **LLM - 1차 처리 (레시피 생성 및 재료 추출):** (`llm.py` 담당)
    *   LLM이 사용자 쿼리를 분석하여 요청된 요리를 파악합니다.
    *   해당 요리의 상세 레시피를 생성하여 `recipes.json`에 저장합니다 (매 요청 시 초기화).
    *   생성된 레시피에서 필요한 재료 목록을 추출하여 `ingredients.json`에 저장합니다 (매 요청 시 초기화, 재료는 리스트 형태로 각 줄에 하나씩 저장).
3.  **RAG - 재료 매칭 및 분석:** (`RAG_test.py`의 `analyze_ingredients_matching` 함수 담당)
    *   미리 준비된 마트 재료 목록(`materials.json`)과 LLM이 추출한 레시피 재료 목록(`ingredients.json`)을 로드합니다.
    *   **정확한 일치 (Exact Match):** 레시피 재료의 핵심 명칭(수량/단위 제거)과 마트 재료의 동의어 목록을 비교하여 정확히 일치하는 항목을 찾습니다.
    *   **유사 재료 탐색 (Similar Match):** 정확히 일치하지 않은 레시피 재료에 대해, RAG 파이프라인을 가동합니다.
        *   마트 재료의 각 동의어에 대해 Bi-Encoder, Cross-Encoder, 어휘적 유사도를 계산하고 평균냅니다.
        *   계산된 점수들을 정규화하고 가중합하여 최종 유사도 점수를 산출합니다.
        *   설정된 임계값 이상의 유사도를 가진 마트 재료를 "유사/대체 가능" 항목으로 분류합니다.
    *   **마트에 없는 재료 (Unavailable):** 위 두 단계에서 매칭되지 않은 재료는 "마트에 없음"으로 분류합니다.
    *   각 매칭된 재료에 대해 마트 내 위치 코드를 함께 반환합니다.
4.  **LLM - 2차 처리 (최종 답변 생성):** (`api.py` 또는 `llm.py`에서 최종 프롬프트 구성)
    *   생성된 레시피, 그리고 RAG를 통해 분석된 각 재료의 상태(구매 가능, 유사, 없음) 및 위치 정보를 종합합니다.
    *   LLM이 이 모든 정보를 바탕으로 사용자에게 친절하고 이해하기 쉬운 형태로 최종 답변을 생성하여 출력합니다.

## 5. 데이터 파일 구조

*   **`materials.json`**: 마트 재료 목록 및 위치 정보.
    ```json
    [
      [ ["양배추"], "A1" ],
      [ ["딸기", "생딸기"], "A3" ],
      [ ["마늘", "다진마늘", "통마늘", "깐마늘"], "A4" ],
      // ... 기타 재료
    ]
    ```
    *   각 항목은 `[동의어_리스트, 위치_코드]` 형태입니다.
*   **`recipes.json`**: LLM이 생성한 레시피 정보 (매 요청 시 초기화).
    ```json
    {
      "query": "김치찌개 레시피",
      "recipe": "1. 김치를 볶는다...\n2. 돼지고기를 넣고 볶는다...\n..."
    }
    ```
*   **`ingredients.json`**: LLM이 추출한 레시피 재료 목록 (매 요청 시 초기화).
    ```json
    {
      "ingredients": [
        "배추김치 300g",
        "돼지고기 목살 200g",
        "두부 1모",
        "대파 1/2대",
        "양파 1/4개",
        "다진 마늘 1큰술",
        "고춧가루 1큰술",
        "국간장 1작은술",
        "물 또는 육수 500ml"
      ]
    }
    ```

## 6. 설치 및 실행 방법

### 6.1. 사전 요구사항

*   Python 3.8 이상
*   pip (Python 패키지 관리자)
*   (선택사항) CUDA 지원 NVIDIA GPU (LLM 및 일부 `sentence-transformers` 모델의 빠른 추론을 위해)

### 6.2. 설치 과정

1.  **프로젝트 클론:**
    ```bash
    git clone <프로젝트_저장소_URL>
    cd <프로젝트_디렉토리>
    ```

2.  **가상 환경 생성 및 활성화 (권장):**
    ```bash
    python -m venv venv
    # Windows
    venv\Scripts\activate
    # macOS/Linux
    source venv/bin/activate
    ```

3.  **필수 라이브러리 설치:**
    ```bash
    pip install -r requirements.txt
    ```
    `requirements.txt` 예시:
    ```
    transformers
    sentence-transformers
    faiss-cpu
    torch
    numpy
    thefuzz
    python-Levenshtein # thefuzz의 Levenshtein 기능을 위해 필요할 수 있음
    ```

4.  **`materials.json` 준비:**
    프로젝트 루트 디렉토리에 위에서 설명한 형식의 `materials.json` 파일을 준비합니다. 실제 마트의 재료 목록과 위치 코드를 반영해야 합니다.

5.  **(선택사항) LLM 모델 다운로드 또는 API 키 설정:**
    *   Hugging Face 등에서 LLM 모델을 사용하는 경우, 모델을 미리 다운로드 받거나 API 키 등 인증 설정을 환경 변수 또는 코드 내에 구성해야 할 수 있습니다. (HyperCLOVAX의 경우 별도 인증 필요)

### 6.3. 실행 방법

프로젝트의 메인 실행 파일인 `api.py`를 실행합니다.

```bash
python api.py
```

실행 후, 터미널에 레시피 또는 질문을 입력하라는 프롬프트가 나타납니다.

## 7. 주요 파일 구조 (예상)

```
.
├── api.py                  # 메인 실행 파일, 사용자 입력 처리 및 전체 파이프라인 조율
├── llm.py                  # LLM 관련 기능 (레시피 생성, 재료 추출, 최종 답변 생성)
├── RAG_test.py             # RAG 기반 재료 매칭 및 분석 로직 (analyze_ingredients_matching 함수)
├── location.py             # (보조) materials.json에서 위치 정보를 추출하는 유틸리티 (동의어 처리 포함)
├── materials.json          # 마트 재료 및 위치 데이터
├── recipes.json            # 임시 생성 레시피 저장 (실행 시 생성/초기화)
├── ingredients.json        # 임시 추출 재료 저장 (실행 시 생성/초기화)
├── requirements.txt        # 프로젝트 의존성 패키지 목록
└── README.md               # 본 파일
```

## 8. 개발 과정에서의 주요 고민 및 설계 의도

본 프로젝트는 단순히 기능을 구현하는 것을 넘어, 사용자의 실제적인 문제를 해결하고 높은 품질의 결과를 제공하기 위한 깊이 있는 고민과 반복적인 개선 과정을 거쳤습니다.

*   **재료 매칭 정확도 극대화:**
    *   초기 단순 임베딩 유사도 검색의 한계(예: "배추김치" vs "배")를 인지하고, 이를 극복하기 위해 다중 Bi-Encoder, 다중 Cross-Encoder, 어휘적 유사도를 결합하는 복합적인 RAG 시스템을 구축했습니다.
    *   각 유사도 점수를 효과적으로 결합하기 위해 가중합 방식을 도입하고, 각 모델의 점수 스케일 차이를 해결하기 위해 정교한 정규화 전략을 적용했습니다.
*   **데이터 표현의 중요성:**
    *   `materials.json`에 재료 동의어를 배열 형태로 저장하고, `ingredients.json`의 재료를 개별 항목 리스트로 저장하도록 변경하여, 시스템 전반의 데이터 처리 정확성과 매칭률을 향상시켰습니다.
*   **LLM을 활용한 전문가 시스템 모방:**
    *   단순 질의응답을 넘어, LLM이 여러 단계(레시피 구상 → 생성 → 재료 추출 → 정보 종합)에 걸쳐 사고하고 처리하는 "전문가 시스템"과 유사한 파이프라인을 구축하고자 했습니다.
*   **투명성과 디버깅:**
    *   복잡한 유사도 계산 과정의 투명성을 확보하고 문제 해결을 용이하게 하기 위해, 각 단계별 점수와 최종 결합 과정을 상세히 로그로 출력하도록 시스템을 설계했습니다.
*   **범용성 추구:**
    *   특정 레시피(예: 김치찌개)에 국한되지 않고, 어떤 요리 관련 질문에도 일관된 고품질의 분석과 답변을 제공할 수 있는 범용 시스템 구축을 목표로 했습니다.

## 9. 향후 개선 방향 (선택 사항)

*   **UI/UX 개선:** 웹 인터페이스 또는 챗봇 형태로 개발하여 사용자 편의성 증대.
*   **개인화:** 사용자별 요리 선호도, 알레르기 정보 등을 반영한 맞춤형 레시피 추천.
*   **실시간 재고 연동:** 실제 마트의 실시간 재고 API와 연동 (가능하다면).
*   **이미지 입력 지원:** 요리 이미지나 재료 이미지를 통한 검색 기능 추가.
*   **성능 최적화:** 대량의 재료 데이터 처리 및 LLM 추론 속도 개선.

---
